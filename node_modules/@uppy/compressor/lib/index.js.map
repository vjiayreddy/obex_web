{"version":3,"names":["BasePlugin","RateLimitedQueue","getFileNameAndExtension","prettierBytes","CompressorJS","locale","Compressor","constructor","uppy","opts","id","type","defaultLocale","defaultOptions","quality","limit","i18nInit","prepareUpload","bind","compress","blob","Promise","resolve","reject","success","error","fileIDs","totalCompressedSize","compressedFiles","compressAndApplyResult","wrapPromiseFunction","file","compressedBlob","data","compressedSavingsSize","size","log","name","extension","setFileState","setFileMeta","push","err","promises","map","fileID","getFile","emit","mode","message","i18n","isRemote","slice","startsWith","all","info","install","addPreProcessor","uninstall","removePreProcessor"],"sources":["index.js"],"sourcesContent":["import { BasePlugin } from '@uppy/core'\nimport { RateLimitedQueue } from '@uppy/utils/lib/RateLimitedQueue'\nimport getFileNameAndExtension from '@uppy/utils/lib/getFileNameAndExtension'\nimport prettierBytes from '@transloadit/prettier-bytes'\nimport CompressorJS from 'compressorjs/dist/compressor.common.js'\nimport locale from './locale.js'\n\nexport default class Compressor extends BasePlugin {\n  #RateLimitedQueue\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.id = this.opts.id || 'Compressor'\n    this.type = 'modifier'\n\n    this.defaultLocale = locale\n\n    const defaultOptions = {\n      quality: 0.6,\n      limit: 10,\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.#RateLimitedQueue = new RateLimitedQueue(this.opts.limit)\n\n    this.i18nInit()\n\n    this.prepareUpload = this.prepareUpload.bind(this)\n    this.compress = this.compress.bind(this)\n  }\n\n  compress (blob) {\n    return new Promise((resolve, reject) => {\n      /* eslint-disable no-new */\n      new CompressorJS(blob, {\n        ...this.opts,\n        success: resolve,\n        error: reject,\n      })\n    })\n  }\n\n  async prepareUpload (fileIDs) {\n    let totalCompressedSize = 0\n    const compressedFiles = []\n    const compressAndApplyResult = this.#RateLimitedQueue.wrapPromiseFunction(\n      async (file) => {\n        try {\n          const compressedBlob = await this.compress(file.data)\n          const compressedSavingsSize = file.data.size - compressedBlob.size\n          this.uppy.log(`[Image Compressor] Image ${file.id} compressed by ${prettierBytes(compressedSavingsSize)}`)\n          totalCompressedSize += compressedSavingsSize\n          const { name, type, size } = compressedBlob\n          const extension = name && getFileNameAndExtension(name).extension\n          this.uppy.setFileState(file.id, {\n            ...(name && { name }),\n            ...(extension && { extension }),\n            ...(type && { type }),\n            ...(size && { size }),\n            data: compressedBlob,\n          })\n          this.uppy.setFileMeta(file.id, { type })\n          compressedFiles.push(file)\n        } catch (err) {\n          this.uppy.log(`[Image Compressor] Failed to compress ${file.id}:`, 'warning')\n          this.uppy.log(err, 'warning')\n        }\n      },\n    )\n\n    const promises = fileIDs.map((fileID) => {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-progress', file, {\n        mode: 'indeterminate',\n        message: this.i18n('compressingImages'),\n      })\n\n      if (file.isRemote) {\n        return Promise.resolve()\n      }\n\n      // Some browsers (Firefox) add blobs with empty file type, when files are\n      // added from a folder. Uppy auto-detects type from extension, but leaves the original blob intact.\n      // However, Compressor.js failes when file has no type, so we set it here\n      if (!file.data.type) {\n        file.data = file.data.slice(0, file.data.size, file.type)\n      }\n\n      if (!file.type.startsWith('image/')) {\n        return Promise.resolve()\n      }\n\n      return compressAndApplyResult(file)\n    })\n\n    // Why emit `preprocess-complete` for all files at once, instead of\n    // above when each is processed?\n    // Because it leads to StatusBar showing a weird “upload 6 files” button,\n    // while waiting for all the files to complete pre-processing.\n    await Promise.all(promises)\n\n    this.uppy.emit('compressor:complete', compressedFiles)\n\n    // Only show informer if Compressor mananged to save at least a kilobyte\n    if (totalCompressedSize > 1024) {\n      this.uppy.info(\n        this.i18n('compressedX', {\n          size: prettierBytes(totalCompressedSize),\n        }),\n        'info',\n      )\n    }\n\n    for (const fileID of fileIDs) {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-complete', file)\n    }\n  }\n\n  install () {\n    this.uppy.addPreProcessor(this.prepareUpload)\n  }\n\n  uninstall () {\n    this.uppy.removePreProcessor(this.prepareUpload)\n  }\n}\n"],"mappings":"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"}