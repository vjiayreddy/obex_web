{"version":3,"names":["getFileType","isPreviewSupported","remoteFileObjToLocal","View","constructor","plugin","opts","filterItems","items","state","getPluginState","filterInput","filter","folder","name","toLowerCase","indexOf","recordShiftKeyPress","e","isShiftKeyPressed","shiftKey","toggleCheckbox","file","stopPropagation","preventDefault","currentTarget","focus","folders","files","concat","lastCheckbox","prevIndex","currentIndex","currentSelection","slice","reducedCurrentSelection","item","uppy","restrictionError","validateRestrictions","getFiles","push","info","message","infoTimeout","setPluginState","isChecked","id","some","provider","isHandlingScroll","preFirstRender","bind","handleError","clearSelection","cancelPicking","didFirstRender","onFirstRender","shouldHandleScroll","event","scrollHeight","scrollTop","offsetHeight","target","scrollPosition","dashboard","getPlugin","hideAllPanels","error","i18n","log","toString","isAuthError","details","getTagFile","tagFile","source","data","type","mimeType","isRemote","meta","body","fileId","remote","companionUrl","url","fileUrl","requestPath","providerOptions","providerName","fileType","preview","thumbnail","author","authorName","String","authorUrl","setLoading","loading"],"sources":["View.js"],"sourcesContent":["import getFileType from '@uppy/utils/lib/getFileType'\nimport isPreviewSupported from '@uppy/utils/lib/isPreviewSupported'\nimport remoteFileObjToLocal from '@uppy/utils/lib/remoteFileObjToLocal'\n\nexport default class View {\n  constructor (plugin, opts) {\n    this.plugin = plugin\n    this.provider = opts.provider\n\n    this.isHandlingScroll = false\n\n    this.preFirstRender = this.preFirstRender.bind(this)\n    this.handleError = this.handleError.bind(this)\n    this.clearSelection = this.clearSelection.bind(this)\n    this.cancelPicking = this.cancelPicking.bind(this)\n  }\n\n  preFirstRender () {\n    this.plugin.setPluginState({ didFirstRender: true })\n    this.plugin.onFirstRender()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  shouldHandleScroll (event) {\n    const { scrollHeight, scrollTop, offsetHeight } = event.target\n    const scrollPosition = scrollHeight - (scrollTop + offsetHeight)\n\n    return scrollPosition < 50 && !this.isHandlingScroll\n  }\n\n  clearSelection () {\n    this.plugin.setPluginState({ currentSelection: [], filterInput: '' })\n  }\n\n  cancelPicking () {\n    this.clearSelection()\n\n    const dashboard = this.plugin.uppy.getPlugin('Dashboard')\n\n    if (dashboard) {\n      dashboard.hideAllPanels()\n    }\n  }\n\n  handleError (error) {\n    const { uppy } = this.plugin\n    const message = uppy.i18n('companionError')\n\n    uppy.log(error.toString())\n\n    if (error.isAuthError) {\n      return\n    }\n\n    uppy.info({ message, details: error.toString() }, 'error', 5000)\n  }\n\n  // todo document what is a \"tagFile\" or get rid of this concept\n  getTagFile (file) {\n    const tagFile = {\n      id: file.id,\n      source: this.plugin.id,\n      data: file,\n      name: file.name || file.id,\n      type: file.mimeType,\n      isRemote: true,\n      meta: {},\n      body: {\n        fileId: file.id,\n      },\n      remote: {\n        companionUrl: this.plugin.opts.companionUrl,\n        url: `${this.provider.fileUrl(file.requestPath)}`,\n        body: {\n          fileId: file.id,\n        },\n        providerOptions: this.provider.opts,\n        providerName: this.provider.name,\n        provider: this.provider.provider,\n      },\n    }\n\n    const fileType = getFileType(tagFile)\n\n    // TODO Should we just always use the thumbnail URL if it exists?\n    if (fileType && isPreviewSupported(fileType)) {\n      tagFile.preview = file.thumbnail\n    }\n\n    if (file.author) {\n      if (file.author.name != null) tagFile.meta.authorName = String(file.author.name)\n      if (file.author.url) tagFile.meta.authorUrl = file.author.url\n    }\n\n    return tagFile\n  }\n\n  filterItems = (items) => {\n    const state = this.plugin.getPluginState()\n    if (!state.filterInput || state.filterInput === '') {\n      return items\n    }\n    return items.filter((folder) => {\n      return folder.name.toLowerCase().indexOf(state.filterInput.toLowerCase()) !== -1\n    })\n  }\n\n  recordShiftKeyPress = (e) => {\n    this.isShiftKeyPressed = e.shiftKey\n  }\n\n  /**\n   * Toggles file/folder checkbox to on/off state while updating files list.\n   *\n   * Note that some extra complexity comes from supporting shift+click to\n   * toggle multiple checkboxes at once, which is done by getting all files\n   * in between last checked file and current one.\n   */\n  toggleCheckbox = (e, file) => {\n    e.stopPropagation()\n    e.preventDefault()\n    e.currentTarget.focus()\n    const { folders, files } = this.plugin.getPluginState()\n    const items = this.filterItems(folders.concat(files))\n    // Shift-clicking selects a single consecutive list of items\n    // starting at the previous click and deselects everything else.\n    if (this.lastCheckbox && this.isShiftKeyPressed) {\n      const prevIndex = items.indexOf(this.lastCheckbox)\n      const currentIndex = items.indexOf(file)\n      const currentSelection = (prevIndex < currentIndex)\n        ? items.slice(prevIndex, currentIndex + 1)\n        : items.slice(currentIndex, prevIndex + 1)\n      const reducedCurrentSelection = []\n\n      // Check restrictions on each file in currentSelection,\n      // reduce it to only contain files that pass restrictions\n      for (const item of currentSelection) {\n        const { uppy } = this.plugin\n        const restrictionError = uppy.validateRestrictions(\n          remoteFileObjToLocal(item),\n          [...uppy.getFiles(), ...reducedCurrentSelection],\n        )\n\n        if (!restrictionError) {\n          reducedCurrentSelection.push(item)\n        } else {\n          uppy.info({ message: restrictionError.message }, 'error', uppy.opts.infoTimeout)\n        }\n      }\n      this.plugin.setPluginState({ currentSelection: reducedCurrentSelection })\n      return\n    }\n\n    this.lastCheckbox = file\n    const { currentSelection } = this.plugin.getPluginState()\n    if (this.isChecked(file)) {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.filter((item) => item.id !== file.id),\n      })\n    } else {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.concat([file]),\n      })\n    }\n  }\n\n  isChecked = (file) => {\n    const { currentSelection } = this.plugin.getPluginState()\n    // comparing id instead of the file object, because the reference to the object\n    // changes when we switch folders, and the file list is updated\n    return currentSelection.some((item) => item.id === file.id)\n  }\n\n  setLoading (loading) {\n    this.plugin.setPluginState({ loading })\n  }\n}\n"],"mappings":"AAAA,OAAOA,WAAP,MAAwB,6BAAxB;AACA,OAAOC,kBAAP,MAA+B,oCAA/B;AACA,OAAOC,oBAAP,MAAiC,sCAAjC;AAEA,eAAe,MAAMC,IAAN,CAAW;EACxBC,WAAW,CAAEC,MAAF,EAAUC,IAAV,EAAgB;IAAA,KA4F3BC,WA5F2B,GA4FZC,KAAD,IAAW;MACvB,MAAMC,KAAK,GAAG,KAAKJ,MAAL,CAAYK,cAAZ,EAAd;;MACA,IAAI,CAACD,KAAK,CAACE,WAAP,IAAsBF,KAAK,CAACE,WAAN,KAAsB,EAAhD,EAAoD;QAClD,OAAOH,KAAP;MACD;;MACD,OAAOA,KAAK,CAACI,MAAN,CAAcC,MAAD,IAAY;QAC9B,OAAOA,MAAM,CAACC,IAAP,CAAYC,WAAZ,GAA0BC,OAA1B,CAAkCP,KAAK,CAACE,WAAN,CAAkBI,WAAlB,EAAlC,MAAuE,CAAC,CAA/E;MACD,CAFM,CAAP;IAGD,CApG0B;;IAAA,KAsG3BE,mBAtG2B,GAsGJC,CAAD,IAAO;MAC3B,KAAKC,iBAAL,GAAyBD,CAAC,CAACE,QAA3B;IACD,CAxG0B;;IAAA,KAiH3BC,cAjH2B,GAiHV,CAACH,CAAD,EAAII,IAAJ,KAAa;MAC5BJ,CAAC,CAACK,eAAF;MACAL,CAAC,CAACM,cAAF;MACAN,CAAC,CAACO,aAAF,CAAgBC,KAAhB;MACA,MAAM;QAAEC,OAAF;QAAWC;MAAX,IAAqB,KAAKvB,MAAL,CAAYK,cAAZ,EAA3B;MACA,MAAMF,KAAK,GAAG,KAAKD,WAAL,CAAiBoB,OAAO,CAACE,MAAR,CAAeD,KAAf,CAAjB,CAAd,CAL4B,CAM5B;MACA;;MACA,IAAI,KAAKE,YAAL,IAAqB,KAAKX,iBAA9B,EAAiD;QAC/C,MAAMY,SAAS,GAAGvB,KAAK,CAACQ,OAAN,CAAc,KAAKc,YAAnB,CAAlB;QACA,MAAME,YAAY,GAAGxB,KAAK,CAACQ,OAAN,CAAcM,IAAd,CAArB;QACA,MAAMW,gBAAgB,GAAIF,SAAS,GAAGC,YAAb,GACrBxB,KAAK,CAAC0B,KAAN,CAAYH,SAAZ,EAAuBC,YAAY,GAAG,CAAtC,CADqB,GAErBxB,KAAK,CAAC0B,KAAN,CAAYF,YAAZ,EAA0BD,SAAS,GAAG,CAAtC,CAFJ;QAGA,MAAMI,uBAAuB,GAAG,EAAhC,CAN+C,CAQ/C;QACA;;QACA,KAAK,MAAMC,IAAX,IAAmBH,gBAAnB,EAAqC;UACnC,MAAM;YAAEI;UAAF,IAAW,KAAKhC,MAAtB;UACA,MAAMiC,gBAAgB,GAAGD,IAAI,CAACE,oBAAL,CACvBrC,oBAAoB,CAACkC,IAAD,CADG,EAEvB,CAAC,GAAGC,IAAI,CAACG,QAAL,EAAJ,EAAqB,GAAGL,uBAAxB,CAFuB,CAAzB;;UAKA,IAAI,CAACG,gBAAL,EAAuB;YACrBH,uBAAuB,CAACM,IAAxB,CAA6BL,IAA7B;UACD,CAFD,MAEO;YACLC,IAAI,CAACK,IAAL,CAAU;cAAEC,OAAO,EAAEL,gBAAgB,CAACK;YAA5B,CAAV,EAAiD,OAAjD,EAA0DN,IAAI,CAAC/B,IAAL,CAAUsC,WAApE;UACD;QACF;;QACD,KAAKvC,MAAL,CAAYwC,cAAZ,CAA2B;UAAEZ,gBAAgB,EAAEE;QAApB,CAA3B;QACA;MACD;;MAED,KAAKL,YAAL,GAAoBR,IAApB;MACA,MAAM;QAAEW;MAAF,IAAuB,KAAK5B,MAAL,CAAYK,cAAZ,EAA7B;;MACA,IAAI,KAAKoC,SAAL,CAAexB,IAAf,CAAJ,EAA0B;QACxB,KAAKjB,MAAL,CAAYwC,cAAZ,CAA2B;UACzBZ,gBAAgB,EAAEA,gBAAgB,CAACrB,MAAjB,CAAyBwB,IAAD,IAAUA,IAAI,CAACW,EAAL,KAAYzB,IAAI,CAACyB,EAAnD;QADO,CAA3B;MAGD,CAJD,MAIO;QACL,KAAK1C,MAAL,CAAYwC,cAAZ,CAA2B;UACzBZ,gBAAgB,EAAEA,gBAAgB,CAACJ,MAAjB,CAAwB,CAACP,IAAD,CAAxB;QADO,CAA3B;MAGD;IACF,CA/J0B;;IAAA,KAiK3BwB,SAjK2B,GAiKdxB,IAAD,IAAU;MACpB,MAAM;QAAEW;MAAF,IAAuB,KAAK5B,MAAL,CAAYK,cAAZ,EAA7B,CADoB,CAEpB;MACA;;MACA,OAAOuB,gBAAgB,CAACe,IAAjB,CAAuBZ,IAAD,IAAUA,IAAI,CAACW,EAAL,KAAYzB,IAAI,CAACyB,EAAjD,CAAP;IACD,CAtK0B;;IACzB,KAAK1C,MAAL,GAAcA,MAAd;IACA,KAAK4C,QAAL,GAAgB3C,IAAI,CAAC2C,QAArB;IAEA,KAAKC,gBAAL,GAAwB,KAAxB;IAEA,KAAKC,cAAL,GAAsB,KAAKA,cAAL,CAAoBC,IAApB,CAAyB,IAAzB,CAAtB;IACA,KAAKC,WAAL,GAAmB,KAAKA,WAAL,CAAiBD,IAAjB,CAAsB,IAAtB,CAAnB;IACA,KAAKE,cAAL,GAAsB,KAAKA,cAAL,CAAoBF,IAApB,CAAyB,IAAzB,CAAtB;IACA,KAAKG,aAAL,GAAqB,KAAKA,aAAL,CAAmBH,IAAnB,CAAwB,IAAxB,CAArB;EACD;;EAEDD,cAAc,GAAI;IAChB,KAAK9C,MAAL,CAAYwC,cAAZ,CAA2B;MAAEW,cAAc,EAAE;IAAlB,CAA3B;IACA,KAAKnD,MAAL,CAAYoD,aAAZ;EACD,CAhBuB,CAkBxB;;;EACAC,kBAAkB,CAAEC,KAAF,EAAS;IACzB,MAAM;MAAEC,YAAF;MAAgBC,SAAhB;MAA2BC;IAA3B,IAA4CH,KAAK,CAACI,MAAxD;IACA,MAAMC,cAAc,GAAGJ,YAAY,IAAIC,SAAS,GAAGC,YAAhB,CAAnC;IAEA,OAAOE,cAAc,GAAG,EAAjB,IAAuB,CAAC,KAAKd,gBAApC;EACD;;EAEDI,cAAc,GAAI;IAChB,KAAKjD,MAAL,CAAYwC,cAAZ,CAA2B;MAAEZ,gBAAgB,EAAE,EAApB;MAAwBtB,WAAW,EAAE;IAArC,CAA3B;EACD;;EAED4C,aAAa,GAAI;IACf,KAAKD,cAAL;IAEA,MAAMW,SAAS,GAAG,KAAK5D,MAAL,CAAYgC,IAAZ,CAAiB6B,SAAjB,CAA2B,WAA3B,CAAlB;;IAEA,IAAID,SAAJ,EAAe;MACbA,SAAS,CAACE,aAAV;IACD;EACF;;EAEDd,WAAW,CAAEe,KAAF,EAAS;IAClB,MAAM;MAAE/B;IAAF,IAAW,KAAKhC,MAAtB;IACA,MAAMsC,OAAO,GAAGN,IAAI,CAACgC,IAAL,CAAU,gBAAV,CAAhB;IAEAhC,IAAI,CAACiC,GAAL,CAASF,KAAK,CAACG,QAAN,EAAT;;IAEA,IAAIH,KAAK,CAACI,WAAV,EAAuB;MACrB;IACD;;IAEDnC,IAAI,CAACK,IAAL,CAAU;MAAEC,OAAF;MAAW8B,OAAO,EAAEL,KAAK,CAACG,QAAN;IAApB,CAAV,EAAkD,OAAlD,EAA2D,IAA3D;EACD,CAnDuB,CAqDxB;;;EACAG,UAAU,CAAEpD,IAAF,EAAQ;IAChB,MAAMqD,OAAO,GAAG;MACd5B,EAAE,EAAEzB,IAAI,CAACyB,EADK;MAEd6B,MAAM,EAAE,KAAKvE,MAAL,CAAY0C,EAFN;MAGd8B,IAAI,EAAEvD,IAHQ;MAIdR,IAAI,EAAEQ,IAAI,CAACR,IAAL,IAAaQ,IAAI,CAACyB,EAJV;MAKd+B,IAAI,EAAExD,IAAI,CAACyD,QALG;MAMdC,QAAQ,EAAE,IANI;MAOdC,IAAI,EAAE,EAPQ;MAQdC,IAAI,EAAE;QACJC,MAAM,EAAE7D,IAAI,CAACyB;MADT,CARQ;MAWdqC,MAAM,EAAE;QACNC,YAAY,EAAE,KAAKhF,MAAL,CAAYC,IAAZ,CAAiB+E,YADzB;QAENC,GAAG,EAAG,GAAE,KAAKrC,QAAL,CAAcsC,OAAd,CAAsBjE,IAAI,CAACkE,WAA3B,CAAwC,EAF1C;QAGNN,IAAI,EAAE;UACJC,MAAM,EAAE7D,IAAI,CAACyB;QADT,CAHA;QAMN0C,eAAe,EAAE,KAAKxC,QAAL,CAAc3C,IANzB;QAONoF,YAAY,EAAE,KAAKzC,QAAL,CAAcnC,IAPtB;QAQNmC,QAAQ,EAAE,KAAKA,QAAL,CAAcA;MARlB;IAXM,CAAhB;IAuBA,MAAM0C,QAAQ,GAAG3F,WAAW,CAAC2E,OAAD,CAA5B,CAxBgB,CA0BhB;;IACA,IAAIgB,QAAQ,IAAI1F,kBAAkB,CAAC0F,QAAD,CAAlC,EAA8C;MAC5ChB,OAAO,CAACiB,OAAR,GAAkBtE,IAAI,CAACuE,SAAvB;IACD;;IAED,IAAIvE,IAAI,CAACwE,MAAT,EAAiB;MACf,IAAIxE,IAAI,CAACwE,MAAL,CAAYhF,IAAZ,IAAoB,IAAxB,EAA8B6D,OAAO,CAACM,IAAR,CAAac,UAAb,GAA0BC,MAAM,CAAC1E,IAAI,CAACwE,MAAL,CAAYhF,IAAb,CAAhC;MAC9B,IAAIQ,IAAI,CAACwE,MAAL,CAAYR,GAAhB,EAAqBX,OAAO,CAACM,IAAR,CAAagB,SAAb,GAAyB3E,IAAI,CAACwE,MAAL,CAAYR,GAArC;IACtB;;IAED,OAAOX,OAAP;EACD;;EA8EDuB,UAAU,CAAEC,OAAF,EAAW;IACnB,KAAK9F,MAAL,CAAYwC,cAAZ,CAA2B;MAAEsD;IAAF,CAA3B;EACD;;AA3KuB"}