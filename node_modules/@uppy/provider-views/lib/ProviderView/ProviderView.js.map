{"version":3,"names":["h","PQueue","getSafeFileId","AuthView","Header","Browser","LoaderView","CloseWrapper","View","packageJson","getOrigin","location","origin","getRegex","value","RegExp","undefined","isOriginAllowed","allowedOrigin","patterns","Array","isArray","map","some","pattern","test","ProviderView","constructor","plugin","opts","defaultOptions","viewType","showTitles","showFilter","showBreadcrumbs","filterQuery","bind","clearFilter","getFolder","getNextFolder","logout","handleAuth","handleScroll","donePicking","render","setPluginState","authenticated","files","folders","directories","filterInput","isSearchVisible","currentSelection","tearDown","id","name","setLoading","res","provider","list","updatedDirectories","state","getPluginState","index","findIndex","dir","slice","concat","title","username","err","handleError","folder","requestPath","lastCheckbox","then","ok","revoked","message","uppy","i18n","url","manual_revoke_url","info","newState","catch","input","ensurePreAuth","authState","btoa","JSON","stringify","clientVersion","VERSION","link","authUrl","uppyVersions","authWindow","window","open","handleToken","e","source","log","companionAllowedHosts","data","parse","error","token","close","removeEventListener","setAuthToken","preFirstRender","addEventListener","event","path","nextPagePath","shouldHandleScroll","isHandlingScroll","response","recursivelyListAllFiles","queue","onFiles","curPath","items","filter","item","isFolder","promises","add","Promise","all","messages","newFiles","file","isEmpty","numNewFiles","concurrency","newFile","tagFile","getTagFile","checkIfFileAlreadyExists","push","numFiles","onIdle","smart_count","addFiles","forEach","clearSelection","viewOptions","didFirstRender","targetViewOptions","loading","isChecked","toggleCheckbox","recordShiftKeyPress","filterItems","hasInput","headerProps","pluginIcon","icon","browserProps","showSearchFilter","search","clearSearch","searchTerm","searchOnInput","searchInputLabel","clearSearchLabel","noResultsLabel","done","cancel","cancelPicking","headerComponent","uppyFiles","getFiles","validateRestrictions","i18nArray","version"],"sources":["ProviderView.jsx"],"sourcesContent":["import { h } from 'preact'\n// eslint-disable-next-line import/no-unresolved\nimport PQueue from 'p-queue'\n\nimport { getSafeFileId } from '@uppy/utils/lib/generateFileID'\n\nimport AuthView from './AuthView.jsx'\nimport Header from './Header.jsx'\nimport Browser from '../Browser.jsx'\nimport LoaderView from '../Loader.jsx'\nimport CloseWrapper from '../CloseWrapper.js'\nimport View from '../View.js'\n\nimport packageJson from '../../package.json'\n\nfunction getOrigin () {\n  // eslint-disable-next-line no-restricted-globals\n  return location.origin\n}\n\nfunction getRegex (value) {\n  if (typeof value === 'string') {\n    return new RegExp(`^${value}$`)\n  } if (value instanceof RegExp) {\n    return value\n  }\n  return undefined\n}\nfunction isOriginAllowed (origin, allowedOrigin) {\n  const patterns = Array.isArray(allowedOrigin) ? allowedOrigin.map(getRegex) : [getRegex(allowedOrigin)]\n  return patterns\n    .some((pattern) => pattern?.test(origin) || pattern?.test(`${origin}/`)) // allowing for trailing '/'\n}\n\n/**\n * Class to easily generate generic views for Provider plugins\n */\nexport default class ProviderView extends View {\n  static VERSION = packageJson.version\n\n  /**\n   * @param {object} plugin instance of the plugin\n   * @param {object} opts\n   */\n  constructor (plugin, opts) {\n    super(plugin, opts)\n    // set default options\n    const defaultOptions = {\n      viewType: 'list',\n      showTitles: true,\n      showFilter: true,\n      showBreadcrumbs: true,\n    }\n\n    // merge default options with the ones set by user\n    this.opts = { ...defaultOptions, ...opts }\n\n    // Logic\n    this.filterQuery = this.filterQuery.bind(this)\n    this.clearFilter = this.clearFilter.bind(this)\n    this.getFolder = this.getFolder.bind(this)\n    this.getNextFolder = this.getNextFolder.bind(this)\n    this.logout = this.logout.bind(this)\n    this.handleAuth = this.handleAuth.bind(this)\n    this.handleScroll = this.handleScroll.bind(this)\n    this.donePicking = this.donePicking.bind(this)\n\n    // Visual\n    this.render = this.render.bind(this)\n\n    // Set default state for the plugin\n    this.plugin.setPluginState({\n      authenticated: false,\n      files: [],\n      folders: [],\n      directories: [],\n      filterInput: '',\n      isSearchVisible: false,\n      currentSelection: [],\n    })\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  tearDown () {\n    // Nothing.\n  }\n\n  #updateFilesAndFolders (res, files, folders) {\n    this.nextPagePath = res.nextPagePath\n    res.items.forEach((item) => {\n      if (item.isFolder) {\n        folders.push(item)\n      } else {\n        files.push(item)\n      }\n    })\n\n    this.plugin.setPluginState({ folders, files })\n  }\n\n  /**\n   * Based on folder ID, fetch a new folder and update it to state\n   *\n   * @param  {string} id Folder id\n   * @returns {Promise}   Folders/files in folder\n   */\n  async getFolder (id, name) {\n    this.setLoading(true)\n    try {\n      const res = await this.provider.list(id)\n      const folders = []\n      const files = []\n      let updatedDirectories\n\n      const state = this.plugin.getPluginState()\n      const index = state.directories.findIndex((dir) => id === dir.id)\n\n      if (index !== -1) {\n        updatedDirectories = state.directories.slice(0, index + 1)\n      } else {\n        updatedDirectories = state.directories.concat([{ id, title: name }])\n      }\n\n      this.username = res.username || this.username\n      this.#updateFilesAndFolders(res, files, folders)\n      this.plugin.setPluginState({ directories: updatedDirectories, filterInput: '' })\n    } catch (err) {\n      this.handleError(err)\n    } finally {\n      this.setLoading(false)\n    }\n  }\n\n  /**\n   * Fetches new folder\n   *\n   * @param  {object} folder\n   */\n  getNextFolder (folder) {\n    this.getFolder(folder.requestPath, folder.name)\n    this.lastCheckbox = undefined\n  }\n\n  /**\n   * Removes session token on client side.\n   */\n  logout () {\n    this.provider.logout()\n      .then((res) => {\n        if (res.ok) {\n          if (!res.revoked) {\n            const message = this.plugin.uppy.i18n('companionUnauthorizeHint', {\n              provider: this.plugin.title,\n              url: res.manual_revoke_url,\n            })\n            this.plugin.uppy.info(message, 'info', 7000)\n          }\n\n          const newState = {\n            authenticated: false,\n            files: [],\n            folders: [],\n            directories: [],\n            filterInput: '',\n          }\n          this.plugin.setPluginState(newState)\n        }\n      }).catch(this.handleError)\n  }\n\n  filterQuery (input) {\n    this.plugin.setPluginState({ filterInput: input })\n  }\n\n  clearFilter () {\n    this.plugin.setPluginState({ filterInput: '' })\n  }\n\n  async handleAuth () {\n    await this.provider.ensurePreAuth()\n\n    const authState = btoa(JSON.stringify({ origin: getOrigin() }))\n    const clientVersion = `@uppy/provider-views=${ProviderView.VERSION}`\n    const link = this.provider.authUrl({ state: authState, uppyVersions: clientVersion })\n\n    const authWindow = window.open(link, '_blank')\n    const handleToken = (e) => {\n      if (e.source !== authWindow) {\n        this.plugin.uppy.log('rejecting event from unknown source')\n        return\n      }\n      if (!isOriginAllowed(e.origin, this.plugin.opts.companionAllowedHosts) || e.source !== authWindow) {\n        this.plugin.uppy.log(`rejecting event from ${e.origin} vs allowed pattern ${this.plugin.opts.companionAllowedHosts}`)\n      }\n\n      // Check if it's a string before doing the JSON.parse to maintain support\n      // for older Companion versions that used object references\n      const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data\n\n      if (data.error) {\n        this.plugin.uppy.log('auth aborted', 'warning')\n        const { uppy } = this.plugin\n        const message = uppy.i18n('authAborted')\n        uppy.info({ message }, 'warning', 5000)\n        return\n      }\n\n      if (!data.token) {\n        this.plugin.uppy.log('did not receive token from auth window', 'error')\n        return\n      }\n\n      authWindow.close()\n      window.removeEventListener('message', handleToken)\n      this.provider.setAuthToken(data.token)\n      this.preFirstRender()\n    }\n    window.addEventListener('message', handleToken)\n  }\n\n  async handleScroll (event) {\n    const path = this.nextPagePath || null\n\n    if (this.shouldHandleScroll(event) && path) {\n      this.isHandlingScroll = true\n\n      try {\n        const response = await this.provider.list(path)\n        const { files, folders } = this.plugin.getPluginState()\n\n        this.#updateFilesAndFolders(response, files, folders)\n      } catch (error) {\n        this.handleError(error)\n      } finally {\n        this.isHandlingScroll = false\n      }\n    }\n  }\n\n  async recursivelyListAllFiles (path, queue, onFiles) {\n    let curPath = path\n\n    while (curPath) {\n      const res = await this.provider.list(curPath)\n      curPath = res.nextPagePath\n\n      const files = res.items.filter((item) => !item.isFolder)\n      const folders = res.items.filter((item) => item.isFolder)\n\n      onFiles(files)\n\n      // recursively queue call to self for each folder\n      const promises = folders.map(async (folder) => queue.add(async () => (\n        this.recursivelyListAllFiles(folder.requestPath, queue, onFiles)\n      )))\n      await Promise.all(promises) // in case we get an error\n    }\n  }\n\n  async donePicking () {\n    this.setLoading(true)\n    try {\n      const { currentSelection } = this.plugin.getPluginState()\n\n      const messages = []\n      const newFiles = []\n\n      for (const file of currentSelection) {\n        if (file.isFolder) {\n          const { requestPath, name } = file\n          let isEmpty = true\n          let numNewFiles = 0\n\n          const queue = new PQueue({ concurrency: 6 })\n\n          const onFiles = (files) => {\n            for (const newFile of files) {\n              const tagFile = this.getTagFile(newFile)\n              const id = getSafeFileId(tagFile)\n              // If the same folder is added again, we don't want to send\n              // X amount of duplicate file notifications, we want to say\n              // the folder was already added. This checks if all files are duplicate,\n              // if that's the case, we don't add the files.\n              if (!this.plugin.uppy.checkIfFileAlreadyExists(id)) {\n                newFiles.push(newFile)\n                numNewFiles++\n                this.setLoading(this.plugin.uppy.i18n('addedNumFiles', { numFiles: numNewFiles }))\n              }\n              isEmpty = false\n            }\n          }\n\n          await this.recursivelyListAllFiles(requestPath, queue, onFiles)\n          await queue.onIdle()\n\n          let message\n          if (isEmpty) {\n            message = this.plugin.uppy.i18n('emptyFolderAdded')\n          } else if (numNewFiles === 0) {\n            message = this.plugin.uppy.i18n('folderAlreadyAdded', {\n              folder: name,\n            })\n          } else {\n            // TODO we don't really know at this point whether any files were actually added\n            // (only later after addFiles has been called) so we should probably rewrite this.\n            // Example: If all files fail to add due to restriction error, it will still say \"Added 100 files from folder\"\n            message = this.plugin.uppy.i18n('folderAdded', {\n              smart_count: numNewFiles, folder: name,\n            })\n          }\n\n          messages.push(message)\n        } else {\n          newFiles.push(file)\n        }\n      }\n\n      // Note: this.plugin.uppy.addFiles must be only run once we are done fetching all files,\n      // because it will cause the loading screen to disappear,\n      // and that will allow the user to start the upload, so we need to make sure we have\n      // finished all async operations before we add any file\n      // see https://github.com/transloadit/uppy/pull/4384\n      this.plugin.uppy.log('Adding remote provider files')\n      this.plugin.uppy.addFiles(newFiles.map((file) => this.getTagFile(file)))\n\n      this.plugin.setPluginState({ filterInput: '' })\n      messages.forEach(message => this.plugin.uppy.info(message))\n\n      this.clearSelection()\n    } catch (err) {\n      this.handleError(err)\n    } finally {\n      this.setLoading(false)\n    }\n  }\n\n  render (state, viewOptions = {}) {\n    const { authenticated, didFirstRender } = this.plugin.getPluginState()\n    const { i18n } = this.plugin.uppy\n\n    if (!didFirstRender) {\n      this.preFirstRender()\n    }\n\n    const targetViewOptions = { ...this.opts, ...viewOptions }\n    const { files, folders, filterInput, loading, currentSelection } = this.plugin.getPluginState()\n    const { isChecked, toggleCheckbox, recordShiftKeyPress, filterItems } = this\n    const hasInput = filterInput !== ''\n    const headerProps = {\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      getFolder: this.getFolder,\n      directories: this.plugin.getPluginState().directories,\n      pluginIcon: this.plugin.icon,\n      title: this.plugin.title,\n      logout: this.logout,\n      username: this.username,\n      i18n,\n    }\n\n    const browserProps = {\n      isChecked,\n      toggleCheckbox,\n      recordShiftKeyPress,\n      currentSelection,\n      files: hasInput ? filterItems(files) : files,\n      folders: hasInput ? filterItems(folders) : folders,\n      username: this.username,\n      getNextFolder: this.getNextFolder,\n      getFolder: this.getFolder,\n\n      // For SearchFilterInput component\n      showSearchFilter: targetViewOptions.showFilter,\n      search: this.filterQuery,\n      clearSearch: this.clearFilter,\n      searchTerm: filterInput,\n      searchOnInput: true,\n      searchInputLabel: i18n('filter'),\n      clearSearchLabel: i18n('resetFilter'),\n\n      noResultsLabel: i18n('noFilesFound'),\n      logout: this.logout,\n      handleScroll: this.handleScroll,\n      done: this.donePicking,\n      cancel: this.cancelPicking,\n      headerComponent: Header(headerProps),\n      title: this.plugin.title,\n      viewType: targetViewOptions.viewType,\n      showTitles: targetViewOptions.showTitles,\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      pluginIcon: this.plugin.icon,\n      i18n: this.plugin.uppy.i18n,\n      uppyFiles: this.plugin.uppy.getFiles(),\n      validateRestrictions: (...args) => this.plugin.uppy.validateRestrictions(...args),\n    }\n\n    if (loading) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <LoaderView i18n={this.plugin.uppy.i18n} loading={loading} />\n        </CloseWrapper>\n      )\n    }\n\n    if (!authenticated) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <AuthView\n            pluginName={this.plugin.title}\n            pluginIcon={this.plugin.icon}\n            handleAuth={this.handleAuth}\n            i18n={this.plugin.uppy.i18n}\n            i18nArray={this.plugin.uppy.i18nArray}\n          />\n        </CloseWrapper>\n      )\n    }\n\n    return (\n      <CloseWrapper onUnmount={this.clearSelection}>\n        {/* eslint-disable-next-line react/jsx-props-no-spreading */}\n        <Browser {...browserProps} />\n      </CloseWrapper>\n    )\n  }\n}\n"],"mappings":"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"}