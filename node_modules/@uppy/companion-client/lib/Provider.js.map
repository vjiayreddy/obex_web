{"version":3,"names":["RequestClient","tokenStorage","getName","id","split","map","s","charAt","toUpperCase","slice","join","Provider","constructor","uppy","opts","provider","name","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","token","Promise","all","getAuthToken","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","getItem","ensurePreAuth","fetchPreAuthToken","Error","authUrl","queries","URLSearchParams","set","hostname","fileUrl","res","post","err","log","list","directory","get","logout","then","removeItem","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionAllowedHosts","pattern","Array","isArray","RegExp","TypeError","test","companionUrl","replace","URL","origin"],"sources":["Provider.js"],"sourcesContent":["'use strict'\n\nimport RequestClient from './RequestClient.js'\nimport * as tokenStorage from './tokenStorage.js'\n\nconst getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nexport default class Provider extends RequestClient {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n  }\n\n  async headers () {\n    const [headers, token] = await Promise.all([super.headers(), this.getAuthToken()])\n    const authHeaders = {}\n    if (token) {\n      authHeaders['uppy-auth-token'] = token\n    }\n\n    if (this.companionKeysParams) {\n      authHeaders['uppy-credentials-params'] = btoa(\n        JSON.stringify({ params: this.companionKeysParams }),\n      )\n    }\n    return { ...headers, ...authHeaders }\n  }\n\n  onReceiveResponse (response) {\n    super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth () {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.')\n      }\n    }\n  }\n\n  authUrl (queries = {}) {\n    const params = new URLSearchParams(queries)\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  async fetchPreAuthToken () {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n    }\n  }\n\n  list (directory) {\n    return this.get(`${this.id}/list/${directory || ''}`)\n  }\n\n  logout () {\n    return this.get(`${this.id}/logout`)\n      .then((response) => Promise.all([\n        response,\n        this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey),\n      ])).then(([response]) => response)\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n    /* eslint-enable no-param-reassign */\n  }\n}\n"],"mappings":"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"}